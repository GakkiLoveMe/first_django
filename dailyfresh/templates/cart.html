{% extends 'base_user.html' %}
{% block head %}
    <script>
        $(function () {
            // 计算小计和总价
            get_total_price();
            // 复选框绑定点击事件
            $(':checkbox:not(#checkall)').click(function () {
                // get_total_price();
                // 获取总价和总数
                var total_price = parseFloat($('.settlements').find('em').text());
                var total_count = parseInt($('.settlements').find('b').text());
                // 获取当前点击的小计和数量
                var price = parseFloat($(this).parent().siblings('.col07').children('em').text());
                var count = parseInt($(this).parent().siblings('.col06').find('.num_show').val());
                if($(this).prop('checked')){
                    total_price += price;
                    total_count +=count;
                }else {
                    total_count -= count;
                    total_price -= price;
                }
                // 重新赋值
                $('.settlements').find('em').text(total_price.toFixed(2));
                $('.settlements').find('b').text(total_count);
                //如有未选中, 多选框取消勾选
                var checkbox_num = $(':checkbox:not(#checkall)').length;
                var checked_num = $(':checked:not(#checkall)').length;
                if (checkbox_num == checked_num){
                    $('#checkall').prop('checked', true);
                }else {
                    $('#checkall').prop('checked', false);
                }
            });
            // 全选框事件
            $('#checkall').click(function () {
                var check = $(this).prop('checked');
                $(':checkbox:not(this)').prop('checked', check);
                get_total_price();
            });
            // 商品数量修改,文本框
            $('.num_show').blur(function () {
                var count = parseInt($(this).val());
                // 数据有效性判断
                if(isNaN(count)){
                    count = 1;
                };
                if(count <=0){
                    count=1;
                    $(this).siblings('.minus').prop('disabled', true)
                }else{
                    $(this).siblings('.minus').prop('disabled', false)
                }
                if(count >=5){
                    count = 5;
                    $(this).siblings('.add').prop('disabled', true)
                }else {
                    $(this).siblings('.add').prop('disabled', false)
                }
                $(this).val(count);
                // 发送post请求
                $.post('/cart/edit', {
                    'sku_id': $(this).parents('.cart_list_td').find(':input:hidden').val(),
                    'count': count,
                    'csrfmiddlewaretoken':'{{ csrf_token }}'
                }, function (data) {
                    if(data.status == 1){
                        //alert(count);
                    };
                });
                get_total_price();
            });
            //+1
            $('.add').click(function () {
                var count = parseInt($(this).siblings('.num_show').val());
                count++;
                $(this).siblings('.num_show').val(count).blur();
            });
            //-1
            $('.minus').click(function () {
                var count = parseInt($(this).siblings('.num_show').val());
                count--;
                $(this).siblings('.num_show').val(count).blur();
            });
            //删除
            $('.col08>a').click(function () {
                var del_ul = $(this).parents('ul');
                if(confirm('确定要删除吗?')){
                    $.post('/cart/delete', {
                        'sku_id': $(this).parents('.cart_list_td').find(':input:hidden').val(),
                        'csrfmiddlewaretoken': '{{ csrf_token }}'
                    }, function (data) {
                        if(data.status == 1){
                            del_ul.remove();
                            get_total_price();
                        };
                    });
                };
            });
        });
        // 计算小计和总价,数量
        function get_total_price() {
            var $pay_money = 0;
            var total_count = 0;
            var total_select = 0;
            $('.cart_list_td').each(function (i, n) {

                var $price = parseFloat($(n).find('.col05>em').text());
                var $count = parseInt($(n).find('.num_show').val());
                var $total_price = $price * $count;
                $(n).find('.col07>em').text($total_price.toFixed(2));
                // 购物车没有商品时
                if(!isNaN($count)){
                    total_count += $count;
                };
                // 判断是否勾选
                if ($(n).find('.col01>input').prop('checked')){
                    $pay_money += $total_price;
                    total_select += $count;
                };
            });
            $('.settlements').find('.col03>em').text($pay_money.toFixed(2)); //总价
            $('.settlements').find('b').text(total_select);
            $('.total_count>em').text(total_count);
        }
    </script>
{% endblock head %}
{% block body2 %}
	<div class="total_count">全部商品<em>2</em>件</div>	
	<ul class="cart_list_th clearfix">
		<li class="col01">商品名称</li>
		<li class="col02">商品单位</li>
		<li class="col03">商品价格</li>
		<li class="col04">数量</li>
		<li class="col05">小计</li>
		<li class="col06">操作</li>
	</ul>
    <form action="/order/" method="get">
        {% for sku in sku_list %}
        <ul class="cart_list_td clearfix">
            <input type="hidden" value="{{ sku.id }}">
            <li class="col01"><input type="checkbox" name="sku_id" checked="checked" value="{{ sku.id }}"></li>
            <li class="col02"><img src="{{ sku.default_image.url }}"></li>
            <li class="col03">{{ sku.name }}<br><em>库存:{{ sku.stock }}</em></li>
            <li class="col04">{{ sku.unit }}</li>
            <li class="col05"><em>{{ sku.price }}</em>元</li>
            <li class="col06">
                <div class="num_add">
                    <input type="button" href="javascript:;" class="add fl" value="+"></input>
                    <input type="text" class="num_show fl" value="{{ sku.cart_count }}">
                    <input type="button" href="javascript:;" class="minus fl" value="-"></input>
                </div>
            </li>
            <li class="col07"><em></em>元</li>
            <li class="col08"><a href="javascript:;">删除</a></li>
        </ul>
            {% empty %}
            <ul class="cart_list_td clearfix"><span style="font-size: 20px;">暂时没有添加任何商品</span></ul>
        {% endfor %}

        <ul class="settlements">
            <li class="col01"><input type="checkbox" id="checkall" checked="checked"></li>
            <li class="col02">全选</li>
            <li class="col03">合计(不含运费)：<span>¥</span><em></em><br>共计<b>2</b>件商品</li>
            <li class="col04"><input type="submit" value="去结算"></li>
        </ul>
    </form>
{% endblock body2 %}
